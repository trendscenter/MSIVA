close all; clear; clc;
% @gsd: generate simulated data
% @gsm: generate simulated mixing matrix

format compact
debug = false;
addpath("/Users/xli77/Documents/MSIVA/scripts");
addpath("/Users/xli77/Documents/MSIVA/scripts/SIVA/");
addpath("/Users/xli77/Documents/MSIVA/scripts/toy_example/");
addpath(genpath('/Users/xli77/Documents/gift/GroupICATv4.0c'));

%% load data
% simple K works with one or two subspaces
seed=7;
Acond=3; % 1 means orthogonal matrix
SNR=(1+999)/1;
num_pc = 12;
num_iter = 0;
M = [1, 2];

% UKB data
X = load('/Users/xli77/Documents/MSIVA/MISA-data/sMRI-fMRI/X.mat').X;

% patient data
% X = load('/Users/xli77/Documents/MSIVA/MISA-data/sMRI-fMRI/X_sz.mat').X;

%% define subspace structure
% S1
S_ = {[1 2], [1 2]; ...
      [3 4 5], [3 4 5]; ...
      [6 7 8 9], [6 7 8 9]; ...
      [   10], [     ]; ...
      [   11], [     ]; ...
      [   12], [     ]; ...
      [     ], [   10]; ...
      [     ], [   11]; ...
      [     ], [   12]};

% S2
% S_ = {[1  2], [1  2]; ...
%       [3  4], [3  4]; ...
%       [5  6], [5  6]; ...
%       [7  8], [7  8]; ...
%       [9 10], [9 10]; ...
%       [  11], [    ]; ...
%       [  12], [    ]; ...
%       [    ], [  11]; ...
%       [    ], [  12]};

% S3
% S_ = {[1 2 3], [1 2 3]; ...
%       [4 5 6], [4 5 6]; ...
%       [7 8 9], [7 8 9]; ...
%       [   10], [     ]; ...
%       [   11], [     ]; ...
%       [   12], [     ]; ...
%       [     ], [   10]; ...
%       [     ], [   11]; ...
%       [     ], [   12]};

% S4
% S_ = {[1 2 3 4], [1 2 3 4]; ...
%       [5 6 7 8], [5 6 7 8]; ...
%       [  9], [   ]; ...
%       [ 10], [   ]; ...
%       [ 11], [   ]; ...
%       [ 12], [   ]; ...
%       [   ], [  9]; ...
%       [   ], [ 10]; ...
%       [   ], [ 11]; ...
%       [   ], [ 12]};

% Set Kotz parameters to multivariate laplace
K = size(S_,1);
eta = ones(K,1);
beta = ones(K,1);
lambda = ones(K,1);

S = cell(size(M));
% from gsd.m
for mm = M
    if issparse(S_{mm})
        S{mm} = S_{mm};
    else
        ii = [];
        jj = [];
        for ii_ = 1:K
            jj_ = length(S_{ii_,mm});
            if jj_ ~= 0
                jj = [jj S_{ii_,mm}];
                ii = [ii ii_*ones(1,jj_)];
            end
        end
        S{mm} = sparse(ii, jj, ones(1,sum([S_{:,mm}] ~= 0)), ...
            K, sum([S_{:,mm}] ~= 0), sum([S_{:,mm}] ~= 0));
    end
end

%% run optimization
% unimodal
[data1_um, aux_um, isi_um] = run_pca_ica(X, S, M, num_pc, num_iter, seed);

% unimodal + multimodal
[data1_ummm, aux_ummm, isi_ummm] = run_mgpca_ica(X, S, M, num_pc, num_iter, seed);

%% save outputs
outpath = '/Users/xli77/Documents/MSIVA/results/SIVA/subspace_struct_234111';
save(fullfile(outpath,'um_neuroimaging.mat'),'data1_um','aux_um');
save(fullfile(outpath,'ummm_neuroimaging.mat'),'data1_ummm','aux_ummm');
